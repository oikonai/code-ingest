version: '3.8'

services:
  # SurrealDB - Local vector database
  surrealdb:
    image: surrealdb/surrealdb:latest
    container_name: code-ingest-surrealdb
    ports:
      - "8000:8000"
    volumes:
      - surrealdb-data:/data
    command: >
      start
      --log trace
      --user root
      --pass root
      file:/data/database.db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - code-ingest-network

  # Ingestion service - One-shot code ingestion
  ingest:
    build:
      context: .
      dockerfile: Dockerfile.ingest
    container_name: code-ingest-ingestion
    depends_on:
      surrealdb:
        condition: service_healthy
    environment:
      # Vector backend configuration
      - VECTOR_BACKEND=surrealdb
      - SURREALDB_URL=http://surrealdb:8000
      - SURREALDB_NS=code_ingest
      - SURREALDB_DB=vectors
      - SURREALDB_USER=root
      - SURREALDB_PASS=root
      
      # Embedding service (external)
      - EMBEDDING_ENDPOINT=${EMBEDDING_ENDPOINT}
      - CLOUDFLARE_AI_GATEWAY_TOKEN=${CLOUDFLARE_AI_GATEWAY_TOKEN}
      - DEEPINFRA_API_KEY=${DEEPINFRA_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-custom-deepinfra/Qwen/Qwen2.5-7B-Instruct-Embedding}
      
      # GitHub token for cloning
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      
      # Optional: Priority filter for ingestion
      - PRIORITY=${PRIORITY:-high}
    volumes:
      - ./repos:/app/repos  # Mount repos directory
      - ./config:/app/config  # Mount config
      - ingest-status:/app/status  # Shared volume for status file
    restart: "no"  # One-shot service
    networks:
      - code-ingest-network

  # MCP server - Query interface
  mcp:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    container_name: code-ingest-mcp
    depends_on:
      surrealdb:
        condition: service_healthy
    ports:
      - "8001:8001"  # MCP server port
    environment:
      # Vector backend configuration
      - VECTOR_BACKEND=surrealdb
      - SURREALDB_URL=http://surrealdb:8000
      - SURREALDB_NS=code_ingest
      - SURREALDB_DB=vectors
      - SURREALDB_USER=root
      - SURREALDB_PASS=root
      
      # Embedding service (for search)
      - EMBEDDING_ENDPOINT=${EMBEDDING_ENDPOINT}
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_AI_GATEWAY_TOKEN}
      - DEEPINFRA_API_KEY=${DEEPINFRA_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-custom-deepinfra/Qwen/Qwen2.5-7B-Instruct-Embedding}
      
      # Health endpoint configuration
      - DOCKER_ENV=true
      - ENABLE_HEALTH_ENDPOINT=true
      - HEALTH_PORT=8001
    volumes:
      - ./config:/app/config  # Mount config
      - ingest-status:/app/status:ro  # Read-only access to status
    restart: unless-stopped
    networks:
      - code-ingest-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  surrealdb-data:
    name: code-ingest-surrealdb-data
  ingest-status:
    name: code-ingest-status

networks:
  code-ingest-network:
    name: code-ingest-network
    driver: bridge
