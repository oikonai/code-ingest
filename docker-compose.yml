services:
  # SurrealDB - Local vector database
  surrealdb:
    image: surrealdb/surrealdb:latest
    container_name: code-ingest-surrealdb
    user: "0"  # Run as root so /data volume is writable (image runs non-root by default)
    ports:
      - "8000:8000"
    volumes:
      - surrealdb-data:/data
    command: >
      start
      --log trace
      --user root
      --pass root
      file:/data/database.db
    # No healthcheck: official image is minimal (no curl/wget). Ingest and MCP entrypoints poll /health.
    networks:
      - code-ingest-network

  # Ingestion service - One-shot full re-ingestion (clone/refresh repos, discover, ingest, derive).
  # To skip re-ingestion and use existing data, start only surrealdb and mcp: docker compose up surrealdb mcp
  ingest:
    build:
      context: .
      dockerfile: Dockerfile.ingest
    container_name: code-ingest-ingestion
    depends_on:
      surrealdb:
        condition: service_started
    environment:
      - SURREALDB_URL=http://surrealdb:8000
      - SURREALDB_NS=code_ingest
      - SURREALDB_DB=vectors
      - SURREALDB_USER=root
      - SURREALDB_PASS=root
      
      # Embedding service (DeepInfra)
      - DEEPINFRA_API_KEY=${DEEPINFRA_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-Qwen/Qwen3-Embedding-8B-batch}
      
      # GitHub token for cloning
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      
      # Optional: Priority filter for ingestion
      - PRIORITY=${PRIORITY:-low}

      # Logging level (DEBUG, INFO, WARNING, ERROR)
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./repos:/app/repos  # Mount repos directory
      - ./config:/app/config  # Mount config
      - ingest-status:/app/status  # Shared volume for status file
    restart: "no"  # One-shot service
    networks:
      - code-ingest-network

  # MCP server - Query interface
  mcp:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    container_name: code-ingest-mcp
    depends_on:
      surrealdb:
        condition: service_started
    ports:
      - "8001:8001"  # MCP server port
    environment:
      - SURREALDB_URL=http://surrealdb:8000
      - SURREALDB_NS=code_ingest
      - SURREALDB_DB=vectors
      - SURREALDB_USER=root
      - SURREALDB_PASS=root
      
      # Embedding service (DeepInfra)
      - DEEPINFRA_API_KEY=${DEEPINFRA_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-Qwen/Qwen3-Embedding-8B-batch}
      
      # Health endpoint and MCP over HTTP (Cursor connects to http://localhost:8001/mcp)
      - DOCKER_ENV=true
      - ENABLE_HEALTH_ENDPOINT=true
      - HEALTH_PORT=8001
      - MCP_HTTP_TRANSPORT=true
      
      # Logging level (DEBUG, INFO, WARNING, ERROR)
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./config:/app/config  # Mount config
      - ingest-status:/app/status:ro  # Read-only access to status
    restart: unless-stopped
    networks:
      - code-ingest-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  surrealdb-data:
    name: code-ingest-surrealdb-data
  ingest-status:
    name: code-ingest-status

networks:
  code-ingest-network:
    name: code-ingest-network
    driver: bridge
